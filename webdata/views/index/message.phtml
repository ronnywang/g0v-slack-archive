<?php
$message_data = json_decode($this->message->data);
if ($message_data->user and $user = User::find($message_data->user)) {
    $user_data = json_decode($user->data);
    $avatar = $user_data->profile->image_72;
} else {
    $avatar = 'https://ca.slack-edge.com/T02G2SXKM-UD94JT3KQ-g8c100274e62-48';
}
if (!property_exists($message_data, 'replies') and $this->replies) {
    $message_data->replies = $this->replies;
    ksort($message_data->replies);
}

$classes = '';
if ($message_data->parent_user_id and !$message_data->is_thread_broadcast) {
    $classes = "thread-message";
}
?>
<div class="message d-flex mb-2 <?= $classes ?>" id="ts-<?= $this->message->ts?>">
    <img class="avatar flex-shrink-0 rounded-3 mt-1" src="<?= $this->escape($avatar) ?>" width="36" height="36">
    <div class="flex-grow-1 ms-2">
        <div class="meta">
            <span class="user-name" title="<?= htmlspecialchars(json_encode($user_data, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT)) ?>"><strong><?= $this->escape(Message::getUserName($message_data->user)) ?></strong></span>
            <span class="message-time small" title="<?= htmlspecialchars(json_encode($message_data, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT)) ?>"><a class="link-secondary link-underline link-underline-opacity-0 link-underline-opacity-75-hover" href="#ts-<?= $this->message->ts ?>"><?= date('H:i:s', $this->message->ts) ?></a></span>
        </div>

    <?php if($message_data->subtype == "thread_broadcast" and property_exists($message_data, 'root')) { ?>
        <div class="thread-root">
            Replied to a thread: <a class="link-underline link-underline-opacity-0 link-underline-opacity-75-hover" href="/index/channel/<?= $this->message->channel_id ?>/<?= date('Y-m', $message_data->thread_ts) ?>#ts-<?= $message_data->thread_ts ?>"><?= date('Y-m-d H:i:s', $message_data->thread_ts) ?></a>
        </div>
    <?php } ?>

        <div class="contents">
            <?= Message::getHTML($message_data) ?>
        </div>

    <?php if (property_exists($message_data, 'files')) {
        foreach ($message_data->files as $file) { ?>
        <figure class="figure my-2">
            <img class="attachment-image rounded" src="<?= $this->escape("/index/file?url=" . urlencode($file->thumb_360)) ?>">
            <figcaption class="figure-caption"><?= $this->escape($file->title) ?></figcaption>
        </figure>
    <?php }} ?>

    <?php if (property_exists($message_data, 'attachments')) {
        foreach ($message_data->attachments as $attachment) { ?>
        <blockquote class="card my-2" title="<?= $this->escape(json_encode($attachment, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT)) ?>">
        <?php if ($attachment->is_msg_unfurl) {
            $embed_message = Message::find([$attachment->channel_id, $attachment->ts]);
            $embed_message_data = json_decode($embed_message->data);
            $embed_channel = Channel::find($attachment->channel_id) ?>
            <div class="card-body">
                <h6 class="card-title">
                    <img class="avatar rounded" src="<?= $this->escape($attachment->author_icon) ?>" width="24" height="24">
                    <span class="user-name"><strong><?= $this->escape($attachment->author_name) ?></strong></span>
                </h6>
                <div class="card-text">
                    <?= Message::getHTML($embed_message_data) ?>
                </div>
                <ul class="message-meta list-inline my-2 text-secondary small">
                    <li class="list-inline-item">
                        Forwarded from
                    <?php if ($embed_channel->is_channel) { ?>
                        <a class="channel text-reset" href="/index/channel/<?= $embed_channel->id ?>">#<?= $this->escape($embed_channel->name) ?></a>
                    <?php } else { ?>
                        a private channel
                    <?php } ?>
                    </li>
                    <li class="list-inline-item"><a class="message-time text-reset" href="/index/channel/<?= $attachment->channel_id ?>/<?= date('Y-m', $attachment->ts) ?>#ts-<?= $attachment->ts ?>"><?= date('Y-m-d H:i:s', $attachment->ts) ?></a></li>
                </ul>
            </div>
        <?php } else { ?>
            <div class="row g-0">
                <div class="col">
                    <div class="card-body">
                        <h6 class="card-title">
                            <?php if ($attachment->service_icon) { ?>
                            <img class="icon" src="<?= $this->escape($attachment->service_icon) ?>" width="16" height="16">
                            <?php } ?>
                            <?= $this->escape($attachment->service_name) ?>
                        </h6>
                        <div class="card-subtitle"><a href="<?= $this->escape($attachment->title_link) ?>"><?= $this->escape($attachment->title) ?></a></div>
                        <div class="card-text">
                            <?= $this->escape($attachment->text) ?>
                        </div>
                    </div>
                </div>
                <?php if ($attachment->image_url) { ?>
                <div class="col-md-auto">
                    <img class="attachment-image img-fluid rounded" src="<?= $this->escape($attachment->image_url) ?>" width="<?= intval($attachment->image_width) ?>" height="<?= intval($attachment->image_height) ?>">
                </div>
                <?php } ?>
            </div>
        <?php } ?>
        </blockquote>
    <?php } ?>
    <?php } ?>

    <?php if (property_exists($message_data, 'reactions')) { ?>
        <ul class="reactions list-inline my-1">
        <?php foreach ($message_data->reactions as $reaction) { ?>
            <li class="list-inline-item badge rounded-pill text-bg-light"><span class="emoji me-1"><?= Message::getEmoji($reaction->name) ?></span><?= $reaction->count ?></li>
        <?php } ?>
        </ul>
    <?php } ?>

    <?php if (property_exists($message_data, 'replies')) { ?>
        <div class="replies my-2">
        <?php foreach ($message_data->replies as $reply) {
            $reply_message = Message::find([$this->message->channel_id, $reply->ts]);
            $reply_message_data = json_decode($reply_message->data);
            $reply_user_data = $reply_message_data->user ? json_decode(User::find($reply_message_data->user)->data) : new stdClass; ?>
            <div class="message d-flex mb-2" id="ts-<?= $reply_message->ts?>">
                <img class="avatar flex-shrink-0 rounded" src="<?= $this->escape($reply_user_data->profile->image_72) ?>" width="24" height="24">
                <div class="flex-grow-1 ms-2">
                    <div class="meta">
                        <span class="user-name" title="<?= htmlspecialchars(json_encode($reply_user_data, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT)) ?>"><strong><?= $this->escape(Message::getUserName($reply_message_data->user)) ?></strong></span>
                        <span class="message-time small" title="<?= htmlspecialchars(json_encode($reply_message_data, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT)) ?>"><a class="link-secondary link-underline link-underline-opacity-0 link-underline-opacity-75-hover" href="#ts-<?= $reply_message->ts ?>"><?= date('Y-m-d H:i:s', $reply_message->ts) ?></a></span>
                    </div>
                    <div class="contents">
                        <?= Message::getHTML($reply_message_data) ?>
                    </div>
                </div>
            </div>
        <?php } ?>
        </div>
    <?php } ?>

    </div>
</div>
